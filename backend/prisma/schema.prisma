generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum GlobalRole {
  admin
  user
}

enum WorkspaceRole {
  owner
  admin
  proposer
  approver
  viewer
}

enum ProposalStatus {
  draft
  submitted
  approved
  rejected
  spent
  cancelled
}

enum ActivityType {
  milestone
  proposal
  kpi_update
  blocker
  note
}

model User {
  id           String     @id @default(uuid())
  email        String     @unique
  name         String
  passwordHash String
  role         GlobalRole @default(user)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  memberships WorkspaceMember[]
  proposals   SpendingProposal[] @relation("proposal_submitter")
  approvals   ProposalApproval[]
}

model Workspace {
  id        String   @id @default(uuid())
  name      String
  startDate DateTime
  endDate   DateTime
  currency  String   @default("USD")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members   WorkspaceMember[]
  cycles    PlanningCycle[]
  wallets   Wallet[]
  proposals SpendingProposal[]
}

model WorkspaceMember {
  id          String        @id @default(uuid())
  workspaceId String
  userId      String
  role        WorkspaceRole
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  workspace Workspace              @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user      User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  linePerms BudgetLinePermission[]

  @@unique([workspaceId, userId])
  @@index([userId])
}

model PlanningCycle {
  id          String   @id @default(uuid())
  workspaceId String
  name        String
  startDate   DateTime
  endDate     DateTime
  isActive    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace   Workspace          @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  budgetLines BudgetLine[]
  operations  Operation[]
  proposals   SpendingProposal[]
  activities  Activity[]

  @@index([workspaceId])
}

model BudgetLine {
  id           String   @id @default(uuid())
  cycleId      String
  code         String
  name         String
  allocatedUsd Decimal  @db.Decimal(18, 6)
  parentId     String?
  pic          String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  cycle    PlanningCycle @relation(fields: [cycleId], references: [id], onDelete: Cascade)
  parent   BudgetLine?   @relation("BudgetLineHierarchy", fields: [parentId], references: [id])
  children BudgetLine[]  @relation("BudgetLineHierarchy")

  perms     BudgetLinePermission[]
  links     BudgetLineOperation[]
  proposals SpendingProposal[]

  @@unique([cycleId, code])
  @@index([cycleId])
}

model Operation {
  id         String   @id @default(uuid())
  cycleId    String
  code       String
  name       String
  hypothesis String
  status     String   @default("on_track")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  cycle PlanningCycle         @relation(fields: [cycleId], references: [id], onDelete: Cascade)
  kpis  KPI[]
  links BudgetLineOperation[]

  @@unique([cycleId, code])
  @@index([cycleId])
}

model KPI {
  id          String   @id @default(uuid())
  operationId String
  name        String
  target      String
  current     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  operation Operation @relation(fields: [operationId], references: [id], onDelete: Cascade)

  @@index([operationId])
}

model BudgetLineOperation {
  budgetLineId String
  operationId  String

  budgetLine BudgetLine @relation(fields: [budgetLineId], references: [id], onDelete: Cascade)
  operation  Operation  @relation(fields: [operationId], references: [id], onDelete: Cascade)

  @@id([budgetLineId, operationId])
}

model SpendingProposal {
  id              String         @id @default(uuid())
  cycleId         String
  workspaceId     String
  budgetLineId    String
  submitterId     String
  amountUsd       Decimal        @db.Decimal(18, 6)
  description     String
  justification   String?
  vendorName      String?
  expectedDate    DateTime?
  status          ProposalStatus @default(draft)
  rejectionReason String?

  fystackWithdrawalId String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  cycle      PlanningCycle      @relation(fields: [cycleId], references: [id], onDelete: Cascade)
  workspace  Workspace          @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  budgetLine BudgetLine         @relation(fields: [budgetLineId], references: [id])
  submitter  User               @relation("proposal_submitter", fields: [submitterId], references: [id])
  approvals  ProposalApproval[]

  @@index([cycleId])
  @@index([workspaceId])
  @@index([submitterId])
  @@index([status])
}

model ProposalApproval {
  id         String   @id @default(uuid())
  proposalId String
  approverId String
  decision   String // approved | rejected
  comment    String?
  createdAt  DateTime @default(now())

  proposal SpendingProposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)
  approver User             @relation(fields: [approverId], references: [id], onDelete: Cascade)

  @@index([proposalId])
  @@index([approverId])
}

model BudgetLinePermission {
  id                String  @id @default(uuid())
  workspaceMemberId String
  budgetLineId      String
  canView           Boolean @default(false)
  canPropose        Boolean @default(false)
  canApprove        Boolean @default(false)

  member     WorkspaceMember @relation(fields: [workspaceMemberId], references: [id], onDelete: Cascade)
  budgetLine BudgetLine      @relation(fields: [budgetLineId], references: [id], onDelete: Cascade)

  @@unique([workspaceMemberId, budgetLineId])
}

model Activity {
  id        String       @id @default(uuid())
  cycleId   String
  type      ActivityType
  title     String
  body      String?
  createdAt DateTime     @default(now())

  cycle PlanningCycle @relation(fields: [cycleId], references: [id], onDelete: Cascade)

  @@index([cycleId, createdAt])
}

model Wallet {
  id              String   @id @default(uuid())
  workspaceId     String
  name            String
  fystackWalletId String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
}

model FystackWebhookEvent {
  id         String   @id @default(uuid())
  event      String
  resourceId String?
  webhookId  String?
  payload    Json
  receivedAt DateTime @default(now())

  @@index([event])
  @@index([resourceId])
}
